<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realtime Database</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <style>
        body {
            font-family: "Roboto", Arial, Helvetica, sans-serif, Verdana;
            background: #dee1e3;
        }
        .container {
            margin-top: 50px;
        }
        .comments-container {
            margin-top: 30px;
        }
        .comment-box {
            margin-bottom: 20px;
            padding: 10px;
            background: #fff;
            border-radius: 5px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        .comment-box .comment-name {
            font-weight: bold;
        }
        .comment-box .comment-date {
            font-size: 0.9em;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Comments</h1>
        <form id="form">
            <div class="form-group">
                <input type="text" id="name" class="form-control" placeholder="Name" required>
            </div>
            <div class="form-group">
                <textarea id="message" class="form-control" placeholder="Message" required></textarea>
            </div>
            <div class="form-group">
                <button type="submit" class="btn btn-primary">Enviar Comentario</button>
            </div>
            <div id="responseMessage" class="alert" style="display: none;"></div>
        </form>
        <div class="comments-container">
            <ul id="comments-list" class="list-unstyled"></ul>
        </div>
    </div>

    <script>
        const connection = new WebSocket('ws://localhost:8080');
        const table = 'comentarios'; // Nombre de la tabla actualizado

        connection.onopen = function() {
            console.log('WebSocket connected');
            connection.send(JSON.stringify({ type: 'subscribe', query: { table } }));
        };

        connection.onerror = function(error) {
            console.error('WebSocket error:', error);
        };

        connection.onmessage = function(event) {
            const data = JSON.parse(event.data);
            if (data.type === 'add') {
                const comment = data.new_val;
                addCommentToList(comment);
            }
        };

        document.getElementById('form').addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('name').value;
            const message = document.getElementById('message').value;
            fetch('http://localhost:3000/insert', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ db: 'test', table, data: { name, message, date: new Date() } }) // Actualización de la base de datos y tabla
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) { // Cambio a 'error' en lugar de 'errors'
                    alert('Failed to insert data: ' + data.error); // Mostrar el mensaje de error recibido del servidor
                } else {
                    addCommentToList({ name, message, date: new Date() });
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
            document.getElementById('form').reset();
        });

        // Función para cargar los comentarios existentes
        window.onload = function() {
            fetch(`http://localhost:3000/get?db=test&table=${table}`)
                .then(response => response.json())
                .then(comments => {
                    comments.forEach(comment => addCommentToList(comment));
                })
                .catch(error => console.error('Failed to load comments:', error));
        };

        function addCommentToList(comment) {
            const commentsList = document.getElementById('comments-list');
            const commentElement = document.createElement('li');
            commentElement.classList.add('comment-box');
            commentElement.innerHTML = `
                <div class="comment-name">${comment.name}</div>
                <div class="comment-date">${new Date(comment.date).toLocaleString()}</div>
                <div class="comment-message">${comment.message}</div>
            `;
            commentsList.appendChild(commentElement);
        }
    </script>
</body>
</html>

